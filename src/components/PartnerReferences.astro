---
const logoModules = import.meta.glob("../assets/img/logos/partner/*.{png,jpg,jpeg,webp,svg}", {
  eager: true,
  import: "default"
});

const toAssetUrl = (asset) => {
  if (typeof asset === "string") return asset;
  if (asset && typeof asset === "object" && "src" in asset) return asset.src;
  return "";
};

const logos = Object.entries(logoModules)
  .map(([path, asset]) => {
    const file = path.split("/").pop() ?? "";
    const label = file
      .replace(/\.[^/.]+$/, "")
      .replace(/[_-]+/g, " ")
      .replace(/\s+Ambulant$/i, "")
      .trim();

    return { file, src: toAssetUrl(asset), alt: `${label} logo` };
  })
  .sort((a, b) => a.file.localeCompare(b.file));

const clinicLogos = logos.filter((logo) => !/ambulant/i.test(logo.file));
const ambulantLogos = logos.filter((logo) => /ambulant/i.test(logo.file));
const allLogos = [...clinicLogos, ...ambulantLogos];
const lang = Astro.props.lang === "de" ? "de" : "en";
const copy = lang === "de"
  ? {
      heading: "Über 300 führende Einrichtungen vertrauen auf CUREO",
      partnerAria: "Partnereinrichtungen",
      mapTitle: "Karte der CUREO Kliniken und Praxen"
    }
  : {
      heading: "Over 300 leading institutions trust in CUREO",
      partnerAria: "Partner institutions",
      mapTitle: "CUREO clinics and practices map"
    };
---

<section class="references" data-reveal>
  <div class="references-shell">
    <header class="references-head">
      <h2>{copy.heading}</h2>
    </header>

    <div class="logo-row" role="list" aria-label={copy.partnerAria}>
      {
        allLogos.map((logo) => (
          <article class="logo-card" role="listitem">
            <img src={logo.src} alt={logo.alt} loading="lazy" />
          </article>
        ))
      }
    </div>

    <div class="map-block">
      <iframe
        src="https://web-access-813613595328.europe-west1.run.app/map"
        title={copy.mapTitle}
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
        allowfullscreen
      ></iframe>
    </div>
  </div>
</section>

<style>
  .references {
    background: linear-gradient(180deg, #f8fcf2 0%, #f3f9eb 100%);
    padding: 1.2rem 1.2rem 2.4rem;
  }

  .references-shell {
    margin: 0 auto;
    max-width: 1240px;
  }

  .references-head {
    margin-bottom: 0.8rem;
  }

  .references-head h2 {
    color: #1d2f1d;
    font-size: clamp(1.25rem, 2vw, 1.95rem);
    letter-spacing: -0.02em;
    margin: 0;
  }

  .logo-row {
    display: flex;
    gap: 0.7rem;
    overflow-x: auto;
    padding: 0.1rem 0.1rem 0.55rem;
    scrollbar-width: thin;
  }

  .logo-card {
    align-items: center;
    background: #fff;
    border-radius: 14px;
    display: flex;
    flex: 0 0 170px;
    height: 88px;
    justify-content: center;
    padding: 0.7rem;
    transition: transform 180ms ease;
  }

  .logo-card img {
    display: block;
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
  }

  .logo-card:hover {
    transform: translateY(-2px);
  }

  .map-block {
    background: #fff;
    border-radius: 18px;
    margin-top: 1rem;
    overflow: hidden;
  }

  .map-block iframe {
    border: 0;
    display: block;
    height: min(70vw, 840px);
    min-height: 640px;
    width: 100%;
  }

  @media (max-width: 700px) {
    .references {
      padding: 0.9rem 0.8rem 1.6rem;
    }

    .logo-card {
      flex-basis: 150px;
      height: 82px;
    }

    .map-block iframe {
      height: min(95vw, 620px);
      min-height: 460px;
    }
  }
</style>
